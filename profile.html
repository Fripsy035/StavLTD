<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≠–î-–°–¢–ê–í | –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <link rel="stylesheet" href="style/styles.css">
    <link rel="stylesheet" href="style/normalize.css">
</head>

<body>
    <header>
        <div class="container">
            <div class="header-top">
                <div class="logo">
                    <img src="img/logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø –°–≠–î-–°–¢–ê–í" class="logo-icon">
                </div>

                <div class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div>
                        <div class="user-name" id="userName"></div>
                        <div class="user-role" id="userRole"></div>
                    </div>
                    <button class="logout-btn">–í—ã–π—Ç–∏</button>
                </div>
                <button class="mobile-menu-toggle">‚ò∞</button>
            </div>
        </div>
        <nav id="main-nav">
            <div class="nav-container">
                <ul class="nav-menu">
                    <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li><a href="documents.html">–î–æ–∫—É–º–µ–Ω—Ç—ã</a></li>
                    <li><a href="approvals.html">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</a></li>
                    <li><a href="reports.html">–û—Ç—á–µ—Ç—ã</a></li>
                    <li><a href="settings.html">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
                    <li><a href="profile.html" class="active">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <div class="container">
        <div class="main-content">
            <div class="content">
                <div class="section-header">
                    <h2 class="section-title">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                </div>

                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar-large" id="profileAvatar"></div>
                        <div class="profile-info">
                            <h3 id="profileName"></h3>
                            <p id="profileEmail"></p>
                            <p id="profileRole"></p>
                        </div>
                    </div>

                    <div class="profile-tabs">
                        <div class="tab active" data-tab="activity">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                        <div class="tab" data-tab="personal">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
                        <div class="tab" data-tab="security">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>
                    </div>

                    <div class="tab-content active" id="activity">
                        <div class="settings-card">
                            <div class="settings-card-header">
                                <h3 class="settings-card-title">–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                            </div>
                            <div class="activity-list" id="activityList"></div>
                        </div>
                    </div>

                    <div class="tab-content" id="personal">
                        <div class="settings-card">
                            <div class="settings-card-header">
                                <h3 class="settings-card-title">–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                            </div>
                            <form class="settings-form" id="personalForm">
                                <div class="form-group">
                                    <label class="form-label" for="fullName">–§–ò–û</label>
                                    <input type="text" class="form-control" id="fullName" name="fullName" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="email">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                    <input type="tel" class="form-control" id="phone" name="phone"
                                        placeholder="+7 (___) ___-__-__" data-phone-mask="true" />
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="department">–û—Ç–¥–µ–ª</label>
                                    <input type="text" class="form-control" id="department" name="department" readonly
                                        disabled>
                                    <div class="form-text">–û—Ç–¥–µ–ª –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è
                                        –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="position">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                                    <input type="text" class="form-control" id="position" name="position" readonly
                                        disabled>
                                    <div class="form-text">–î–æ–ª–∂–Ω–æ—Å—Ç—å –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è
                                        –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)</div>
                                </div>

                                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                            </form>
                        </div>
                    </div>

                    <div class="tab-content" id="security">
                        <div class="settings-card">
                            <div class="settings-card-header">
                                <h3 class="settings-card-title">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
                            </div>
                            <form class="settings-form" id="passwordForm">
                                <div class="form-group">
                                    <label class="form-label" for="currentPassword">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                                    <input type="password" class="form-control" id="currentPassword"
                                        name="currentPassword" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="newPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                    <input type="password" class="form-control" id="newPassword" name="newPassword"
                                        required minlength="6">
                                    <div class="form-text">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="confirmNewPassword">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
                                        –ø–∞—Ä–æ–ª—è</label>
                                    <input type="password" class="form-control" id="confirmNewPassword"
                                        name="confirmNewPassword" required>
                                </div>

                                <button type="submit" class="btn btn-primary">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                            </form>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>–°–∏—Å—Ç–µ–º–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞ "–°–≠–î-–°–¢–ê–í" ¬© 2025</p>
            <p>–ö–æ–º–ø–∞–Ω–∏—è "–°–¢–ê–í –õ–¢–î"</p>
        </div>
    </footer>

    <script src="script/database.js"></script>
    <script src="script/script.js"></script>
    <script src="script/auth.js"></script>
    <script src="script/user-info.js"></script>
    <script src="script/access-control.js"></script>
    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.addEventListener('DOMContentLoaded', async function () {
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π
            if (typeof database === 'undefined' || typeof auth === 'undefined') {
                await new Promise(resolve => {
                    const checkModules = setInterval(() => {
                        if (typeof database !== 'undefined' && typeof auth !== 'undefined') {
                            clearInterval(checkModules);
                            resolve();
                        }
                    }, 100);
                    setTimeout(() => {
                        clearInterval(checkModules);
                        resolve();
                    }, 5000);
                });
            }

            await database.init();
            const user = auth.getCurrentUser();

            if (user) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
                const fullName = user.fullName || user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('profileName').textContent = fullName;
                document.getElementById('profileEmail').textContent = user.email || '';
                document.getElementById('profileRole').textContent = user.role || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
                const initials = auth.getInitials(fullName);
                document.getElementById('profileAvatar').textContent = initials;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ header
                document.getElementById('userName').textContent = fullName;
                document.getElementById('userRole').textContent = user.role || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('userAvatar').textContent = initials;

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
                document.getElementById('fullName').value = fullName;
                document.getElementById('email').value = user.email || '';
                const phoneInput = document.getElementById('phone');
                phoneInput.value = user.phone || '';
                if (window.phoneMask) {
                    window.phoneMask.applyTo(phoneInput);
                }
                document.getElementById('department').value = user.department || '';
                document.getElementById('position').value = user.position || '';

                renderActivity(user);
            } else {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                window.location.href = 'login.html';
            }
        });

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        function validatePhone(phone) {
            if (window.validators && window.validators.validatePhone) {
                return window.validators.validatePhone(phone, { allowEmpty: true });
            }
            if (!phone) return true;
            const cleaned = phone.replace(/[\s\-\(\)\+]/g, '');
            const phoneRegex = /^(\+?7|8)?\d{10}$/;
            return phoneRegex.test(cleaned);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        document.getElementById('personalForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const user = auth.getCurrentUser();
            if (user) {
                const fullName = document.getElementById('fullName').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();

                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!fullName || !email) {
                    notify.error('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–§–ò–û –∏ Email)');
                    return;
                }

                if (!window.validators || !window.validators.validateEmail(email)) {
                    notify.error('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email.');
                    return;
                }

                // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
                if (phone && !validatePhone(phone)) {
                    notify.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: +7 (999) 123-45-67 –∏–ª–∏ 89991234567');
                    return;
                }

                // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–¥–µ–ª –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å - –æ–Ω–∏ –∏–∑–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
                const updatedUser = {
                    ...user,
                    fullName: fullName,
                    email: email,
                    phone: phone
                    // department –∏ position –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º - –æ–Ω–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
                };

                const result = await auth.updateUser(updatedUser);

                if (result) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    document.getElementById('profileName').textContent = updatedUser.fullName;
                    document.getElementById('profileEmail').textContent = updatedUser.email;
                    const initials = auth.getInitials(updatedUser.fullName);
                    document.getElementById('profileAvatar').textContent = initials;

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ header
                    document.getElementById('userName').textContent = updatedUser.fullName;
                    const headerInitials = auth.getInitials(updatedUser.fullName);
                    document.getElementById('userAvatar').textContent = headerInitials;

                    notify.success('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                } else {
                    notify.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–±–æ–≤ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
        const tabs = document.querySelectorAll('.profile-tabs .tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function () {
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö —Ç–∞–±–æ–≤
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–æ–≤
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–±
                const targetTab = this.getAttribute('data-tab');
                const targetContent = document.getElementById(targetTab);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
        document.getElementById('passwordForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmPassword) {
                notify.error('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }

            const user = auth.getCurrentUser();
            auth.changePassword(currentPassword, newPassword).then(result => {
                if (result) {
                    notify.success('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω');
                    document.getElementById('passwordForm').reset();
                } else {
                    notify.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å');
                }
            });
        });

        function renderActivity(user) {
            const list = document.getElementById('activityList');
            if (!list) return;
            const items = buildActivityItems(user);
            if (items.length === 0) {
                list.innerHTML = '<div class="activity-empty">–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞ –ø—É—Å—Ç–∞</div>';
                return;
            }
            list.innerHTML = items.map(item => `
                <div class="activity-item">
                    <div class="activity-icon">${item.icon}</div>
                    <div class="activity-content">
                        <div class="activity-title">${item.title}</div>
                        <div class="activity-date">${item.date}</div>
                    </div>
                </div>
            `).join('');
        }

        function buildActivityItems(user) {
            const entries = [];
            const documents = database.getTable('documents') || [];
            const processes = database.getTable('approval_processes') || [];
            const processesMap = processes.reduce((map, process) => {
                map[process.process_id] = process;
                return map;
            }, {});

            documents.forEach(doc => {
                if (doc.author_id === user.user_id) {
                    entries.push({
                        icon: 'üìÑ',
                        title: `–°–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç "${doc.name}"`,
                        date: formatActivityDate(doc.created_at),
                        dateRaw: doc.created_at
                    });
                }
                if (doc.updated_at && doc.updated_at !== doc.created_at && doc.author_id === user.user_id) {
                    entries.push({
                        icon: '‚úèÔ∏è',
                        title: `–û–±–Ω–æ–≤–ª–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç "${doc.name}"`,
                        date: formatActivityDate(doc.updated_at),
                        dateRaw: doc.updated_at
                    });
                }
            });

            const versions = database.getTable('document_versions') || [];
            versions.forEach(version => {
                if (version.author_id === user.user_id && version.version_number > 1) {
                    const name = getDocumentName(version.document_id);
                    entries.push({
                        icon: 'üìé',
                        title: `–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è ${version.version_number} –¥–ª—è "${name}"`,
                        date: formatActivityDate(version.created_at),
                        dateRaw: version.created_at
                    });
                }
            });

            processes.forEach(process => {
                const docName = getDocumentName(process.document_id);
                if (process.initiator_id === user.user_id) {
                    entries.push({
                        icon: 'üßæ',
                        title: `–ó–∞–ø—É—â–µ–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ "${docName}"`,
                        date: formatActivityDate(process.start_date),
                        dateRaw: process.start_date
                    });
                    if (process.end_date) {
                        entries.push({
                            icon: '‚úÖ',
                            title: `–ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ "${docName}"`,
                            date: formatActivityDate(process.end_date),
                            dateRaw: process.end_date
                        });
                    }
                }
            });

            const steps = database.getTable('approval_steps') || [];
            steps.forEach(step => {
                if (step.assignee_id !== user.user_id) {
                    return;
                }
                const process = processesMap[step.process_id];
                const docName = process ? getDocumentName(process.document_id) : `–ü—Ä–æ—Ü–µ—Å—Å #${step.process_id}`;
                if (step.status === 'approved') {
                    entries.push({
                        icon: '‚úì',
                        title: `–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç "${docName}"`,
                        date: formatActivityDate(step.completed_at || step.assigned_at),
                        dateRaw: step.completed_at || step.assigned_at
                    });
                } else if (step.status === 'pending') {
                    entries.push({
                        icon: '‚è≥',
                        title: `–û–∂–∏–¥–∞–µ—Ç –≤–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ "${docName}"`,
                        date: formatActivityDate(step.assigned_at),
                        dateRaw: step.assigned_at
                    });
                }
            });

            const notifications = database.getTable('notifications') || [];
            notifications
                .filter(notification => notification.user_id === user.user_id)
                .forEach(notification => {
                    entries.push({
                        icon: 'üîî',
                        title: notification.title || notification.message || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
                        date: formatActivityDate(notification.created_at),
                        dateRaw: notification.created_at
                    });
                });

            return entries
                .filter(entry => entry.date)
                .sort((a, b) => new Date(b.dateRaw || b.date) - new Date(a.dateRaw || a.date))
                .slice(0, 15);
        }

        function getDocumentName(documentId) {
            const doc = database.find('documents', d => d.document_id === documentId);
            return doc ? doc.name : `–î–æ–∫—É–º–µ–Ω—Ç #${documentId}`;
        }

        function formatActivityDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) {
                return '';
            }
            const datePart = typeof formatDateBySettings === 'function'
                ? formatDateBySettings(date)
                : date.toLocaleDateString('ru-RU');
            const timePart = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            return `${datePart} ${timePart}`;
        }
    </script>
</body>

</html>